@page "/productos/{CategoriaId:int}"
@using JhiroServer.Services
@using JhiroServer.Models
@using Blazored.LocalStorage
@inject HttpClient Http
@inject ILocalStorageService LocalStorage
@inject ProductoService ProductoService
@inject CarritoService CarritoService
@inject NavigationManager NavigationManager

@if (Categoria == null)
{
    <p>Cargando datos...</p>
}
else
{
    <h1 style="text-align: center; color: #007bff;">@Categoria?.Nombre</h1>
    <p style="text-align: center; color: #6c757d;">@Categoria?.Publicidad</p>

    @if (productos == null)
    {
        <p>Cargando productos...</p>
    }
    else if (productos.Count == 0)
    {
        <p>No hay productos disponibles en esta categoría.</p>
    }
    else
    {
        <div class="container">
            @foreach (var row in GetRows(productos))
            {
                <div class="row">
                    @foreach (var producto in row)
                    {
                        <div class="col-md-4 mb-4">
                            <div class="card product-card shadow-sm border-light rounded">
                                <img src="@producto.ImagenUrl" class="card-img-top" alt="@producto.Nombre">
                                <div class="card-body text-center">
                                    <h5 class="card-title">@producto.Nombre</h5>
                                    <p class="card-text">@producto.Descripcion</p>
                                    <p class="card-text font-weight-bold">Precio: @producto.Precio.ToString("C")</p>
                                    <p class="card-text text-muted">Stock: @producto.Stock</p>
                                    <button class="btn btn-primary" @onclick="() => AgregarAlCarrito(producto.ProductoId)">Agregar al Carrito</button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }

            <div class="d-flex justify-content-between mt-3">
                <button @onclick="PreviousPage" class="btn btn-secondary" disabled="@(pageNumber == 1)">Anterior</button>
                <span class="align-self-center">Página @pageNumber</span>
                <button @onclick="NextPage" class="btn btn-secondary" disabled="@(productos.Count < pageSize)">Siguiente</button>
            </div>
        </div>
    }
}

@code {
    [Parameter]
    public int CategoriaId { get; set; }
    private List<Producto> productos;
    private Categoria Categoria;
    private int pageNumber = 1;
    private int pageSize = 6;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            productos = await ProductoService.GetProductosPorCategoriaAsync(CategoriaId, pageNumber);
            Categoria = await ProductoService.GetCategoriaAsync(CategoriaId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al inicializar datos: {ex.Message}");
        }
    }

    private async Task AgregarAlCarrito(int productoId)
    {
        var authToken = await LocalStorage.GetItemAsync<string>("authToken");
        if (string.IsNullOrEmpty(authToken))
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        try
        {
            // Obtener el carrito del usuario para verificar si el producto ya existe
            var carrito = await CarritoService.GetCarritoByUsuarioId();
            var itemEnCarrito = carrito.FirstOrDefault(c => c.ProductoId == productoId);

            if (itemEnCarrito != null)
            {
                // Si el producto ya está en el carrito, actualizamos la cantidad
                var nuevaCantidad = itemEnCarrito.Cantidad + 1; // Aquí añadimos 1 a la cantidad existente
                var actualizarCantidadExito = await CarritoService.ActualizarCantidad(productoId, nuevaCantidad);
                if (actualizarCantidadExito)
                {
                    Console.WriteLine("Cantidad actualizada en el carrito.");
                }
                else
                {
                    Console.WriteLine("Error al actualizar la cantidad.");
                }
            }
            else
            {
                // Si el producto no está en el carrito, lo agregamos con una cantidad de 1
                var exitoAgregar = await CarritoService.AddToCarrito(productoId, 1);
                if (exitoAgregar)
                {
                    Console.WriteLine("Producto agregado al carrito.");
                }
                else
                {
                    Console.WriteLine("Error al agregar producto al carrito.");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al manejar el carrito: {ex.Message}");
        }
    }

    private async Task NextPage()
    {
        pageNumber++;
        await LoadProductsAsync();
    }

    private async Task PreviousPage()
    {
        if (pageNumber > 1)
        {
            pageNumber--;
            await LoadProductsAsync();
        }
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            productos = await ProductoService.GetProductosPorCategoriaAsync(CategoriaId, pageNumber);
            Categoria = await ProductoService.GetCategoriaAsync(CategoriaId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar productos: {ex.Message}");
        }
    }

    private IEnumerable<IEnumerable<Producto>> GetRows(List<Producto> productos)
    {
        for (int i = 0; i < productos.Count; i += 3)
        {
            yield return productos.Skip(i).Take(3);
        }
    }
}
